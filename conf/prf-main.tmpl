##
## prf-main.tmpl -- by Dario Berzano <dario.berzano@cern.ch>
##
## Configuration file for the static PROOF cluster. Originally conceived by
## Martin Vala <mvala@cern.ch>.
##
## Do not edit this very file: rather, edit the Cheetah template. The
## configuration file itself is automatically generated by means of Cheetah[1].
##
## [1] http://www.cheetahtemplate.org/
##

# This file has been automatically generated by Cheetah: edit the corresponding
# template instead of changing it.

#
# Global variables
#

# The PROOF pool directory
set gPoolPath = $AF_PREFIX/var/proof

# Default ROOT (normally it is a symlink to an AliEn package)
set gRootsys = /opt/alisw/root

## Unused
## set gRootsysDbg = /opt/aaf/root_dbg

# Configuration files for PROOF
set gProofConf = $AF_PREFIX/etc/proof

# Globus directory (for certificates, etc.)
set gGlobusPath = $AF_ALIEN_DIR/globus

# Certificate and key for this machine are in this directory
set gGridSecurityPath = /etc/grid-security

# Used for authentication: current hostname
set gXrdSecGSISRVNAMES = $AF_MASTER

# PROOF packages directory
set gPackageDir = $AF_PREFIX/var/proof/proofbox/$AF_USER/packages

# The PROOF master for this network
set gMaster = $AF_MASTER

# Maximum concurrent sessions
set gProofMaxSessions = 10

# PROOF port (default: 1093)
set gPort = 1093

# Memory limits, in KiB (resident and virtual)
set gMemoryLimitRes = 100000 
set gMemoryLimitVirt = 100000

#
# Global configuration directives
#

# Administration path, that contains sockets
all.adminpath \$gPoolPath/admin

# The PROOF port (see Global variables)
xpd.port \$gPort

# The PROOF resources locator: static is the only one available, it reads the
# configuration from the given file. This configuration might be however
# specified in this very file - the only difference is that this file does not
# get dynamically reloaded
xpd.resource static \$gProofConf/proof.conf

## This "if-fi" block configures all the nodes but \$gMaster as workers too, but
## it is not our case where we have only one machine
## if \$gMaster
## else
##  xpd.role worker
## fi

# This line is special for this configuration: master is also a worker
xpd.role any

# ALICE group belongings are read from the following file. This option must be
# specified twice for very good reasons
xpd.groupfile \$gProofConf/groups.alice.cf
xpd.putrc Proof.GroupFile: \$gProofConf/groups.alice.cf

# The dataset manager runs on the PROOF master only
if \$gMaster
  xpd.datasetsrc file url:\$gPoolPath/datasets mss:root://pmaster.to.infn.it opt:-Av:As: rw=1
fi

# Working directory (a temporary one)
xpd.workdir \$gPoolPath/proofbox

# Environment for AAF compatibility
xpd.putenv ALICE_PROOF_AAF_ALIEN_PACKAGES=$AF_PACK_DIR

# To me it is unclear why these options go here - aren't they xrootd-specific?
xpd.poolurl root://$AF_MASTER/
xpd.namespace $AF_PROOF_EXPORT
xpd.putrc Path.Localroot $AF_PROOF_EXPORT
##xpd.namespace /stor/alipool/alice
##xpd.putrc Path.Localroot /stor/alipool/alice
##xpd.namespace /storage/AliNameSpace/xrdnamespace
##xpd.putrc Path.Localroot /storage/AliNameSpace/xrdnamespace
xpd.putrc ProofServ.DataDir $AF_PROOF_EXPORT/aaf_data/
xpd.datadir $AF_PROOF_EXPORT/aaf_data/ aWM
##xpd.putrc ProofServ.DataDir /storage/AliNameSpace/xrdnamespace/aaf_data/
##xpd.datadir /storage/AliNameSpace/xrdnamespace/aaf_data/ aWM

### Location of merged files (create th new path is not existing)
##xpd.putrc Proof.OutputFile: root://alicecaf.cern.ch:11094//scratch/<group>/<user>/<file>?remote=1                                                                                                                                
##xpd.putrc XNet.Mkpath 1

# Submergers are not removed for now (we should compare AAF configuration)
xpd.putrc Proof.UseMergers 0

# After 10 minutes (600 s) any idle session is disconnected
xpd.putrc ProofServ.IdleTimeout 600

#
# Security configuration: authentication and authorization
#

# The security library
xpd.seclib libXrdSec.so

# We use GSI (Grid Security Infrastructure). Authentication is made over LDAP
sec.protparm gsi -gmapfun:libXrdSecgsiGMAPLDAP.so

# Configuration file for the LDAP query
sec.protparm gsi -gmapfunparms:\$gProofConf/XrdSecgsiGMAPFunLDAP.cf

# Override subject/user mapping here (i.e. for admin purposes)
sec.protparm gsi -gridmap:\$gProofConf/grid-mapfile

# Globus configuration for this machine. The dlgpxy:2 means that *your* proxy
# creates another delegated proxy on each PROOF client. Very useful if, i.e.,
# you want to access alien:// files from each machine running PROOF workers
xpd.sec.protocol gsi -crl:0 -dlgpxy:2 -certdir:\$gGlobusPath/share/certificates -d:0 -cert:\$gGridSecurityPath/hostcert.pem -key:\$gGridSecurityPath/hostkey.pem -exppxy:<workdir>/<user>/.creds/x509_u<uid>

# Where to save delegations
xpd.putenv XrdSecGSIUSERPROXY=<workdir>/<user>/.creds/x509_u<uid>
xpd.putenv X509_USER_PROXY=<workdir>/<user>/.creds/x509_u<uid>
xpd.putenv XrdSecSSLUSERCERT=<workdir>/<user>/.creds/x509_u<uid>
xpd.putenv XrdSecSSLUSERKEY=<workdir>/<user>/.creds/x509_u<uid>

# Directory of valid CAs (used for standard SSL)
xpd.putenv XrdSecSSLCADIR=\$gGlobusPath/share/certificates

# AliEn stuff - don't know why I need it...
xpd.putenv GCLIENT_SERVER_LIST=pcapiserv08.cern.ch:10000|

# Directory of valid CAs (used for Globus extensions to SSL)
xpd.putenv XrdSecGSICADIR=\$gGlobusPath/share/certificates

# See corresponding global variable above
xpd.putenv XrdSecGSISRVNAMES=\$gXrdSecGSISRVNAMES

# Same thing as dlgpxy switch above
xpd.putrc XSec.GSI.DelegProxy 2

# Used to generate AliEn token
xpd.putenv alien_API_USER=<user>

# Packetizer obscure (to me) option...
#xpd.putrc Packetizer.MaxWorkersPerNode 1000

# Maximum number of PROOF sessions for the scheduler
xpd.schedparam mxsess:\$gProofMaxSessions
##wmx:\$gProofMaxWorkersPerNode

# Quotas
xpd.putrc ProofServ.UserQuotas maxquerykept=5

# Packages
xpd.putrc Proof.GlobalPackageDirs \$gPackageDir
xpd.exportpath \$gPackageDir

# Memory limits in MiB (by default high number, meaning no limits)
xpd.putenv PROOF_RESMEMMAX=\$gMemoryLimitRes
xpd.putenv PROOF_VIRTMEMMAX=\$gMemoryLimitVirt

##
## Dataset manager configuration
##

##dsmgrd.stagecmd /opt/aaf/alien/api/bin/xrdstagetool -d 0 \$URLTOSTAGE
##dsmgrd.sleepsecs 30
##dsmgrd.scandseveryloops 20

##dsmgrd.parallelxfrs 20
##dsmgrd.maxfilesinqueue 1000
##dsmgrd.corruptafterfails 10
##dsmgrd.apmonurl apmon://193.206.184.58
##dsmgrd.apmondsprefix PROOF::TAF::STORAGE_datasets

##dsmgrd.syncdseveryloops 10

##
## PROOF query monitoring (for accounting, etc.)
## See for details: http://root.cern.ch/drupal/content/enabling-query-monitoring
##

## This is to log using the syslog facility -- unrecommended, better on SQL
##xpd.putrc ProofServ.LogToSysLog a1

## This line enables SQL monitoring: several SQL lines might be specified
##xpd.putrc ProofServ.Monitoring: SQL mysql://localhost:3306 proofacc 8hysCAG5Hc9nA83 proofacc.proofquerylog,
##                                   ^^^^^^^^^^^^^^^^^^^^^^ ^^^^^^^^ ^^^^^^^^^^^^^^^ ^^^^^^^^ ^^^^^^^^^^^^^
##                                   MySQL host name + port username  cleartext pwd  database name of table

## MonALISA monitoring
##xpd.putrc +ProofServ.Monitoring: MonaLisa 193.206.184.58 PROOF::TAF::STORAGE_myproof
##                                         ^^^^^^^^^^^^^^ ^^^^^^^^^^^^^^^^^^^^^^^^^^^
##                                          ApMon server         MonALISA tag

#
# Available ROOT versions
#

# Current ROOT version (used to launch xproofd)
xpd.rootsys $AF_ROOT_PROOF current

# All ROOT versions
#for $RootVer in $TPL_ROOT_VER.split('|')
#if ($RootVer == '')
  #continue
#end if
xpd.rootsys $TPL_ROOT_PREFIX/$RootVer/$RootVer VO_ALICE@ROOT::$RootVer
#end for
